{"version":3,"sources":["../../src/controllers/submission.controller.ts"],"sourcesContent":["import { NextFunction, Request, Response } from 'express';\nimport { Container } from 'typedi';\nimport { OpenaiService } from '@/services/openai.service';\nimport { Submission } from '@/interfaces/submission.interface';\nimport { HttpException } from '@/exceptions/HttpException';\nimport { ContractsService } from '@/services/contracts.service';\n\nexport class SubmissionController {\n  public openai = Container.get(OpenaiService);\n  public contracts = Container.get(ContractsService);\n\n  public submitReceipt = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n    try {\n      const body: Omit<Submission, 'timestamp'> = req.body;\n\n      const submissionRequest: Submission = {\n        ...body,\n        timestamp: Date.now(),\n      };\n      // Submission validation with smart contract\n      await this.contracts.validateSubmission(submissionRequest);\n\n      const validationResult = await this.openai.validateImage(body.image);\n\n      if (validationResult == undefined || !('validityFactor' in (validationResult as object))) {\n        throw new HttpException(500, 'Error validating image');\n      }\n\n      const validityFactor = validationResult['validityFactor'];\n\n      if (validityFactor > 0.5) {\n        if (!(await this.contracts.registerSubmission(submissionRequest))) {\n          throw new HttpException(500, 'Error registering submission and sending rewards');\n        }\n      }\n\n      res.status(200).json({ validation: validationResult });\n    } catch (error) {\n      next(error);\n      return;\n    }\n  };\n}\n"],"names":["SubmissionController","openai","Container","get","OpenaiService","contracts","ContractsService","submitReceipt","req","res","next","body","submissionRequest","timestamp","Date","now","validateSubmission","validationResult","validateImage","image","undefined","HttpException","validityFactor","registerSubmission","status","json","validation","error"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BAOaA;;;eAAAA;;;wBANa;+BACI;+BAEA;kCACG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAE1B,IAAA,AAAMA,uBAAN,MAAMA;;QACX,uBAAOC,UAASC,iBAAS,CAACC,GAAG,CAACC,4BAAa;QAC3C,uBAAOC,aAAYH,iBAAS,CAACC,GAAG,CAACG,kCAAgB;QAEjD,uBAAOC,iBAAgB,OAAOC,KAAcC,KAAeC;YACzD,IAAI;gBACF,MAAMC,OAAsCH,IAAIG,IAAI;gBAEpD,MAAMC,oBAAgC,wCACjCD;oBACHE,WAAWC,KAAKC,GAAG;;gBAGrB,MAAM,IAAI,CAACV,SAAS,CAACW,kBAAkB,CAACJ;gBAExC,MAAMK,mBAAmB,MAAM,IAAI,CAAChB,MAAM,CAACiB,aAAa,CAACP,KAAKQ,KAAK;gBAEnE,IAAIF,oBAAoBG,aAAa,CAAE,CAAA,oBAAqBH,gBAA0B,GAAI;oBACxF,MAAM,IAAII,4BAAa,CAAC,KAAK;gBAC/B;gBAEA,MAAMC,iBAAiBL,gBAAgB,CAAC,iBAAiB;gBAEzD,IAAIK,iBAAiB,KAAK;oBACxB,IAAI,CAAE,MAAM,IAAI,CAACjB,SAAS,CAACkB,kBAAkB,CAACX,oBAAqB;wBACjE,MAAM,IAAIS,4BAAa,CAAC,KAAK;oBAC/B;gBACF;gBAEAZ,IAAIe,MAAM,CAAC,KAAKC,IAAI,CAAC;oBAAEC,YAAYT;gBAAiB;YACtD,EAAE,OAAOU,OAAO;gBACdjB,KAAKiB;gBACL;YACF;QACF;;AACF"}